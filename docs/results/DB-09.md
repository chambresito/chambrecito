# DB-09: Add Foreign Key Constraints

## Status: Complete

## Description

Add foreign key constraints to maintain referential integrity between tables.

## Implementation Details

**Source File:** `supabase/migrations/001_init.sql`

### Foreign Key Constraints

| Table | Column | References | On Delete |
|-------|--------|------------|-----------|
| `markets` | `resolution_rule_id` | `resolution_rules(id)` | `SET NULL` |
| `predictions` | `market_id` | `markets(id)` | `RESTRICT` |
| `token_ledger` | `market_id` | `markets(id)` | `RESTRICT` |
| `token_ledger` | `prediction_id` | `predictions(id)` | `RESTRICT` |
| `market_snapshots` | `market_id` | `markets(id)` | `RESTRICT` |
| `reputation_points` | `market_id` | `markets(id)` | `RESTRICT` |

### Implementation Examples

Inline foreign key:
```sql
market_id uuid not null references markets(id) on delete restrict
```

Separate constraint (for conditional creation):
```sql
alter table markets
  add constraint markets_resolution_rule_fk
  foreign key (resolution_rule_id)
  references resolution_rules(id)
  on delete set null;
```

### Delete Behavior

- **RESTRICT**: Prevents deletion of referenced rows. Used for critical relationships where orphaned records would be invalid.
- **SET NULL**: Sets the foreign key to NULL when referenced row is deleted. Used for optional relationships (e.g., resolution rules).

### Design Notes

- `user_id` columns do NOT have foreign keys to `auth.users` - this provides flexibility and avoids coupling to Supabase auth internals
- All market-related tables use `RESTRICT` to prevent accidental data loss
- The `resolution_rule_id` uses `SET NULL` because markets can exist without rules
