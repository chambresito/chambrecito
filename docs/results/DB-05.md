# DB-05: Create `market_snapshots` table

## Status: Complete

## Description

Create the `market_snapshots` table for storing time-series data of aggregate market consensus.

## Implementation Details

**Source File:** `supabase/migrations/001_init.sql`

### Table Schema

```sql
create table if not exists market_snapshots (
  id uuid primary key default gen_random_uuid(),
  market_id uuid not null references markets(id) on delete restrict,
  snapshot_at timestamptz not null default now(),
  total_predictions integer not null,
  yes_count integer not null,
  no_count integer not null
);
```

### Constraints

- `market_snapshots_counts_chk`: Ensures `total_predictions >= 0 and yes_count >= 0 and no_count >= 0`
- Foreign key to `markets(id)` with `on delete restrict`

### Indexes

- `market_snapshots_market_idx`: Index on `market_id`
- `market_snapshots_time_idx`: Index on `snapshot_at`

### Comments

- Table: "Derived counts for market trend visualization."

## Deviations from Original Spec

| Original Spec | Actual Implementation |
|---------------|----------------------|
| `yes_tokens` field | `yes_count` field (count-based, not token-based) |
| `no_tokens` field | `no_count` field (count-based, not token-based) |
| `participants` field | `total_predictions` field |
| `taken_at` field | `snapshot_at` field |

### Design Note

The implementation uses prediction counts rather than token amounts. This aligns with the separation of concerns where tokens are managed by vudy.com and this table tracks participation metrics for visualization purposes.
