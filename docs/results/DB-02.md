# DB-02: Create `predictions` table

## Status: Complete

## Description

Create the `predictions` table for storing user predictions on markets. This table is immutable (no updates or deletes allowed).

## Implementation Details

**Source File:** `supabase/migrations/001_init.sql`

### Table Schema

```sql
create table if not exists predictions (
  id uuid primary key default gen_random_uuid(),
  user_id uuid not null,
  market_id uuid not null references markets(id) on delete restrict,
  choice prediction_choice not null,
  action_type text not null,
  idempotency_key text not null,
  created_at timestamptz not null default now()
);
```

### ENUMs

- `prediction_choice`: `'yes'`, `'no'`

### Constraints

- `predictions_choice_chk`: Ensures `choice in ('yes', 'no')`
- Foreign key to `markets(id)` with `on delete restrict`

### Indexes

- `predictions_idempotency_uidx`: Unique index on `idempotency_key`
- `predictions_market_idx`: Index on `market_id`
- `predictions_user_idx`: Index on `user_id`

### Immutability Trigger

```sql
create trigger predictions_immutable_trg
before update or delete on predictions
for each row execute procedure block_update_delete();
```

### Comments

- Table: "User predictions; immutable and append-only."
- `idempotency_key`: "Stable key for idempotent prediction placement."

## Deviations from Original Spec

| Original Spec | Actual Implementation |
|---------------|----------------------|
| `side` field | `choice` field with enum |
| `tokens_used` field | Moved to `token_ledger` table |
| Foreign key to `auth.users` | `user_id` without FK (allows flexibility) |
| No `action_type` | Added for tracking action context |
| No `idempotency_key` | Added for idempotent operations |
| No immutability trigger | Added trigger to prevent updates/deletes |
