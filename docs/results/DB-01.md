# DB-01: Create `markets` table

## Status: Complete

## Description

Create the `markets` table for storing prediction market data ingested from X API.

## Implementation Details

**Source File:** `supabase/migrations/001_init.sql`

### Table Schema

```sql
create table if not exists markets (
  id uuid primary key default gen_random_uuid(),
  source_topic_id text not null,
  topic_text text not null,
  topic_slug text not null,
  question_text text not null,
  description text,
  subject_type subject_type not null,
  verification_required boolean not null default true,
  verification_source_url text,
  starts_at timestamptz not null,
  ends_at timestamptz not null,
  status market_status not null default 'open',
  resolution_rule_id uuid,
  resolved_outcome boolean,
  resolved_at timestamptz,
  resolution_evidence jsonb,
  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now()
);
```

### ENUMs

- `market_status`: `'open'`, `'resolved'`, `'canceled'`
- `subject_type`: `'public_figure'`, `'organization'`, `'protocol'`, `'event'`

### Constraints

- `markets_time_window_chk`: Ensures `ends_at > starts_at`
- `markets_verification_chk`: Ensures verification source URL is provided when verification is required

### Indexes

- `markets_source_topic_id_uidx`: Unique index on `source_topic_id`
- `markets_status_idx`: Index on `status`
- `markets_topic_slug_idx`: Index on `topic_slug`
- `markets_subject_type_idx`: Index on `subject_type`

### Comments

- Table: "Auto-ingested prediction topics from X API."
- `source_topic_id`: "Stable ID from X source; used for idempotent ingest."
- `resolution_evidence`: "Deterministic evidence used for resolution."
- `subject_type`: "Categorization for safety rules; public_figure enforced for chisme markets."
- `verification_required`: "True when external verification is required."
- `verification_source_url`: "Public URL used to verify the market outcome."

## Deviations from Original Spec

| Original Spec | Actual Implementation |
|---------------|----------------------|
| `question` field | `question_text` field |
| `resolves_at` field | `ends_at` field (with `starts_at` for time window) |
| Status: `disabled` | Status: `canceled` |
| No `source_topic_id` | Added for idempotent X API ingest |
| No `topic_text`, `topic_slug` | Added for display and routing |
| No `resolution_rule_id` | Added for linking to resolution rules |
| No `resolved_outcome`, `resolved_at`, `resolution_evidence` | Added for resolution tracking |
