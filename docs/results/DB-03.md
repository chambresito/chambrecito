# DB-03: Create `token_ledger` table

## Status: Complete

## Description

Create the `token_ledger` table as an append-only, immutable mirror ledger for token consumption. The source of truth is vudy.com.

## Implementation Details

**Source File:** `supabase/migrations/001_init.sql`

### Table Schema

```sql
create table if not exists token_ledger (
  id uuid primary key default gen_random_uuid(),
  user_id uuid not null,
  market_id uuid not null references markets(id) on delete restrict,
  prediction_id uuid not null references predictions(id) on delete restrict,
  vudy_tx_id text not null,
  entry_type ledger_entry_type not null default 'consume',
  amount integer not null,
  created_at timestamptz not null default now()
);
```

### ENUMs

- `ledger_entry_type`: `'consume'`

### Constraints

- `token_ledger_amount_chk`: Ensures `amount > 0`
- Foreign key to `markets(id)` with `on delete restrict`
- Foreign key to `predictions(id)` with `on delete restrict`

### Indexes

- `token_ledger_vudy_tx_uidx`: Unique index on `vudy_tx_id`
- `token_ledger_user_idx`: Index on `user_id`
- `token_ledger_market_idx`: Index on `market_id`

### Immutability Trigger

```sql
create trigger token_ledger_immutable_trg
before update or delete on token_ledger
for each row execute procedure block_update_delete();
```

### Comments

- Table: "Immutable append-only mirror of vudy consumption."
- `vudy_tx_id`: "Unique transaction ID from vudy.com."

## Deviations from Original Spec

| Original Spec | Actual Implementation |
|---------------|----------------------|
| `action` field | `entry_type` field with enum |
| `related_prediction_id` field | `prediction_id` field with FK constraint |
| No `market_id` | Added for direct market reference |
| Action ENUM: `consume` | `ledger_entry_type` ENUM: `'consume'` |
| UNIQUE on `vudy_tx_id` | Implemented as unique index |
| "No UPDATE or DELETE allowed" | Enforced via `block_update_delete()` trigger |
